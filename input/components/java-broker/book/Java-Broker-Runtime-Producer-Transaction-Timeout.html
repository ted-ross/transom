<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>11.4. Producer Transaction Timeout</title><link rel="stylesheet" type="text/css" href="css/style.css"><meta name="generator" content="DocBook XSL Stylesheets V1.76.1"><link rel="home" href="index.html" title="AMQP Messaging Broker (Java)"><link rel="up" href="Java-Broker-Runtime.html" title="Chapter 11. Runtime"><link rel="prev" href="Java-Broker-Runtime-Disk-Space-Management.html" title="11.3. Disk Space Management"><link rel="next" href="Java-Broker-Runtime-Handling-Undeliverable-Messages.html" title="11.5. Handing Undeliverable Messages"></head><body><div class="container" bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><DIV class="header"><DIV class="logo"><H1>Apache Qpid™</H1><H2>Open Source AMQP Messaging</H2></DIV></DIV><DIV class="menu_box"><DIV class="menu_box_top"></DIV><DIV class="menu_box_body"><H3>Apache Qpid</H3><UL><LI><A href="http://qpid.apache.org/index.html">Home</A></LI><LI><A href="http://qpid.apache.org/download.html">Download</A></LI><LI><A href="http://qpid.apache.org/getting_started.html">Getting Started</A></LI><LI><A href="http://www.apache.org/licenses/">License</A></LI><LI><A href="https://cwiki.apache.org/qpid/faq.html">FAQ</A></LI></UL></DIV><DIV class="menu_box_bottom"></DIV><DIV class="menu_box_top"></DIV><DIV class="menu_box_body"><H3>Documentation</H3><UL><LI><A href="http://qpid.apache.org/documentation.html#doc-release">Latest Release</A></LI><LI><A href="http://qpid.apache.org/documentation.html#doc-trunk">Trunk</A></LI><LI><A href="http://qpid.apache.org/documentation.html#doc-archives">Archive</A></LI></UL></DIV><DIV class="menu_box_bottom"></DIV><DIV class="menu_box_top"></DIV><DIV class="menu_box_body"><H3>Community</H3><UL><LI><A href="http://qpid.apache.org/getting_involved.html">Getting Involved</A></LI><LI><A href="http://qpid.apache.org/source_repository.html">Source Repository</A></LI><LI><A href="http://qpid.apache.org/mailing_lists.html">Mailing Lists</A></LI><LI><A href="https://cwiki.apache.org/qpid/">Wiki</A></LI><LI><A href="https://issues.apache.org/jira/browse/qpid">Issue Reporting</A></LI><LI><A href="http://qpid.apache.org/people.html">People</A></LI><LI><A href="http://qpid.apache.org/acknowledgements.html">Acknowledgements</A></LI></UL></DIV><DIV class="menu_box_bottom"></DIV><DIV class="menu_box_top"></DIV><DIV class="menu_box_body"><H3>Developers</H3><UL><LI><A href="https://cwiki.apache.org/qpid/building.html">Building Qpid</A></LI><LI><A href="https://cwiki.apache.org/qpid/developer-pages.html">Developer Pages</A></LI></UL></DIV><DIV class="menu_box_bottom"></DIV><DIV class="menu_box_top"></DIV><DIV class="menu_box_body"><H3>About AMQP</H3><UL><LI><A href="http://qpid.apache.org/amqp.html">What is AMQP?</A></LI></UL></DIV><DIV class="menu_box_bottom"></DIV><DIV class="menu_box_top"></DIV><DIV class="menu_box_body"><H3>About Apache</H3><UL><LI><A href="http://www.apache.org">Home</A></LI><LI><A href="http://www.apache.org/foundation/sponsorship.html">Sponsorship</A></LI><LI><A href="http://www.apache.org/foundation/thanks.html">Thanks</A></LI><LI><A href="http://www.apache.org/security/">Security</A></LI></UL></DIV><DIV class="menu_box_bottom"></DIV></DIV><div class="main_text_area"><div class="main_text_area_top"></div><div class="main_text_area_body"><DIV class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">AMQP Messaging Broker (Java)</a></span> &gt; <span class="breadcrumb-link"><a href="Java-Broker-Runtime.html">Runtime</a></span> &gt; <span class="breadcrumb-node">Producer Transaction Timeout</span></DIV><div class="section" title="11.4. Producer Transaction Timeout"><div class="titlepage"><div><div><h2 class="title"><a name="Java-Broker-Runtime-Producer-Transaction-Timeout"></a>11.4. Producer Transaction Timeout</h2></div></div></div><div class="section" title="11.4.1. General Information"><div class="titlepage"><div><div><h3 class="title"><a name="Java-Broker-Runtime-Producer-Transaction-Timeout-GeneralInformation"></a>11.4.1. General Information</h3></div></div></div><p> The transaction timeout mechanism is used to control broker resources when clients
   producing messages using transactional sessions hang or otherwise become unresponsive, or simply
   begin a transaction and keep using it without ever calling <a class="ulink" href="http://docs.oracle.com/javaee/6/api/javax/jms/Session.html#commit" target="_top">Session#commit()</a>.</p><p>Users can choose to configure an idleWarn or openWarn threshold, after which the identified
   transaction should be logged as a WARN level alert as well as (more importantly) an idleClose or
   openClose threshold after which the transaction and the connection it applies to will be
   closed.</p><p>This feature is particularly useful in environments where the owner of the broker does not
   have full control over the implementation of clients, such as in a shared services
   deployment.</p><p>The following section provide more details on this feature and its use.</p></div><div class="section" title="11.4.2. Purpose"><div class="titlepage"><div><div><h3 class="title"><a name="Java-Broker-Runtime-Producer-Transaction-Timeout-Purpose"></a>11.4.2. Purpose</h3></div></div></div><p> This feature has been introduced to address the scenario where an open transaction on the
   broker holds an open transaction on the persistent store. This can have undesirable consequences
   if the store does not time out or close long-running transactions, such as with <a class="link" href="Java-Broker-Stores-BDB-Store.html" title="8.4. BDB Store">BDB</a>. This can can result in a rapid increase in
   disk usage size, bounded only by available space, due to growth of the transaction log. </p></div><div class="section" title="11.4.3. Scope"><div class="titlepage"><div><div><h3 class="title"><a name="Java-Broker-Runtime-Producer-Transaction-Timeout-Scope"></a>11.4.3. Scope</h3></div></div></div><p>Note that only <a class="ulink" href="http://docs.oracle.com/javaee/6/api/javax/jms/MessageProducer.html" target="_top">MessageProducer</a> clients will be affected by a transaction timeout, since store
   transaction lifespan on a consumer only spans the execution of the call to Session#commit() and
   there is no scope for a long-lived transaction to arise.</p><p>It is also important to note that the transaction timeout mechanism is purely a JMS
   transaction timeout, and unrelated to any other timeouts in the Qpid client library and will have
   no impact on any RDBMS your application may utilise.</p></div><div class="section" title="11.4.4. Effect"><div class="titlepage"><div><div><h3 class="title"><a name="Java-Broker-Runtime-Producer-Transaction-Timeout-Effect"></a>11.4.4. Effect</h3></div></div></div><p>Full details of configuration options are provided in the sections that follow. This section
   gives a brief overview of what the Transaction Timeout feature can do.</p><div class="section" title="11.4.4.1. Broker Logging and Connection Close"><div class="titlepage"><div><div><h4 class="title"><a name="Java-Broker-Runtime-Producer-Transaction-Timeout-Effect-Broker-Side"></a>11.4.4.1. Broker Logging and Connection Close</h4></div></div></div><p>When the openWarn or idleWarn specified threshold is exceeded, the broker will log a WARN
    level alert with details of the connection and channel on which the threshold has been exceeded,
    along with the age of the transaction.</p><p>When the openClose or idleClose specified threshold value is exceeded, the broker will
    throw an exception back to the client connection via the <a class="ulink" href="http://docs.oracle.com/javaee/6/api/javax/jms/ExceptionListener.html" target="_top">ExceptionListener</a>, log the
    action and then close the connection.</p><p>The example broker log output shown below is where the idleWarn threshold specified is
    lower than the idleClose threshold and the broker therefore logs the idle transaction 3 times
    before the close threshold is triggered and the connection closed out.</p><pre class="screen">CHN-1008 : Idle Transaction : 13,116 ms
CHN-1008 : Idle Transaction : 14,116 ms
CHN-1008 : Idle Transaction : 15,118 ms
CHN-1003 : Close
   </pre><p>The second example broker log output shown below illustrates the same mechanism operating
    on an open transaction.</p><pre class="screen">
CHN-1007 : Open Transaction : 12,406 ms
CHN-1007 : Open Transaction : 13,406 ms
CHN-1007 : Open Transaction : 14,406 ms
CHN-1003 : Close
   </pre></div><div class="section" title="11.4.4.2. Client Side Effect"><div class="titlepage"><div><div><h4 class="title"><a name="Java-Broker-Runtime-Producer-Transaction-Timeout-Effect-Client-Side"></a>11.4.4.2. Client Side Effect</h4></div></div></div><p>After a Close threshold has been exceeded, the trigger client will receive this exception
    on its <a class="ulink" href="http://docs.oracle.com/javaee/6/api/javax/jms/ExceptionListener.html" target="_top">exception
    listener</a>, prior to being disconnected:</p><code class="computeroutput">org.apache.qpid.AMQConnectionClosedException: Error: Idle transaction timed out
    [error code 506: resource error]</code><p>Any later attempt to use the connection will result in this exception being thrown:</p><pre class="screen">Producer: Caught an Exception: javax.jms.IllegalStateException: Object org.apache.qpid.client.AMQSession_0_8@129b0e1 has been closed
    javax.jms.IllegalStateException: Object org.apache.qpid.client.AMQSession_0_8@129b0e1 has been closed
    at org.apache.qpid.client.Closeable.checkNotClosed(Closeable.java:70)
    at org.apache.qpid.client.AMQSession.checkNotClosed(AMQSession.java:555)
    at org.apache.qpid.client.AMQSession.createBytesMessage(AMQSession.java:573)
   </pre><p>Thus clients must be able to handle this case successfully, reconnecting where required and
    registering an exception listener on all connections. This is critical, and must be communicated
    to client applications by any broker owner switching on transaction timeouts.</p></div></div><div class="section" title="11.4.5. Configuration"><div class="titlepage"><div><div><h3 class="title"><a name="Java-Broker-Runtime-Producer-Transaction-Timeout-Configuration"></a>11.4.5. Configuration</h3></div></div></div><div class="section" title="11.4.5.1. Configuration"><div class="titlepage"><div><div><h4 class="title"><a name="Java-Broker-Runtime-Producer-Transaction-Timeout-Configuration-Overview"></a>11.4.5.1. Configuration</h4></div></div></div><p>Transaction timeouts are configurable separately on each defined virtual host, using the
    virtualhosts.xml file.</p><p>We would recommend that only warnings are configured at first, which should allow broker
    administrators to obtain an idea of the distribution of transaction lengths on their systems,
    and configure production settings appropriately for both warning and closure. Ideally
    establishing thresholds should be achieved in a representative UAT environment, with clients and
    broker running, prior to any production deployment.</p><p>It is impossible to give suggested values, due to the large variation in usage depending on
    the applications using a broker. However, clearly transactions should not span the expected
    lifetime of any client application as this would indicate a hung client.</p><p>When configuring warning and closure timeouts, it should be noted that these only apply to
    message producers that are connected to the broker, but that a timeout will cause the connection
    to be closed - this disconnecting all producers and consumers created on that connection.</p><p>This should not be an issue for environments using Mule or Spring, where connection
    factories can be configured appropriately to manage a single MessageProducer object per JMS
    Session and Connection. Clients that use the JMS API directly should be aware that sessions
    managing both consumers and producers, or multiple producers, will be affected by a single
    producer hanging or leaving a transaction idle or open, and closed, and must take appropriate
    action to handle that scenario.</p></div><div class="section" title="11.4.5.2. Virtualhosts.xml"><div class="titlepage"><div><div><h4 class="title"><a name="Java-Broker-Runtime-Producer-Transaction-Timeout-Configuration-Virtualhosts"></a>11.4.5.2. Virtualhosts.xml</h4></div></div></div><p> The JMS transaction timeouts are configured on each virtual host defined in the XML
    configuration files.</p><p> The default values for each of the parameters is 0, indicating that the particular check
    is disabled.</p><p> Any or all of the parameters can be set, using the desired value in milliseconds, and will
    be checked each time the housekeeping process runs, usually set to run every 30 seconds in
    standard configuration. The meaning of each property is as follows:</p><p>
    </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>openWarn - the time a transaction can be open for (with activity occurring on it) after
       which a warning alert will be issued.</p></li><li class="listitem"><p>openClose - the time a transaction can be open for before the connection it is on is
       closed.</p></li><li class="listitem"><p>idleWarn - the time a transaction can be idle for (with no activity occurring on it)
       after which a warning alert will be issued.</p></li><li class="listitem"><p>idleClose - the time a transaction can be idle for before the connection it is on is
       closed.</p></li></ul></div><p>
   </p><p> The virtualhosts configuration is shown below, and must occur inside the
   //virtualhosts/virtualhost/name/ elements: </p><div class="example"><a name="idp780048"></a><p class="title"><b>Example 11.4. Configuring producer transaction timeout</b></p><div class="example-contents"><pre class="programlisting">
&lt;transactionTimeout&gt;
    &lt;openWarn&gt;10000&lt;/openWarn&gt;
    &lt;openClose&gt;20000&lt;/openClose&gt;
    &lt;idleWarn&gt;5000&lt;/idleWarn&gt;
    &lt;idleClose&gt;15000&lt;/idleClose&gt;
&lt;/transactionTimeout&gt;
   </pre></div></div><br class="example-break"></div></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="Java-Broker-Runtime-Disk-Space-Management.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="Java-Broker-Runtime.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="Java-Broker-Runtime-Handling-Undeliverable-Messages.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">11.3. Disk Space Management </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 11.5. Handing Undeliverable Messages</td></tr></table></div><div class="main_text_area_bottom"></div></div></div></body></html>
